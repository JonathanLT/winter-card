{% extends "base" %}

{% block title %}🎅 Secret Santa{% endblock %}

{% block content %}
    <h1>🎅 Secret Santa</h1>

    <p>
        Le <strong>Secret Santa</strong> (ou « Père Noël secret » en français) est un jeu ou une tradition populaire pendant la période de Noël,
        souvent organisé entre amis, collègues ou membres d’une famille. Voici le <strong>principe</strong> :
    </p>

    <ol>
        <li><strong>🎁 Tirage au sort anonyme</strong>
            <ul>
                <li>Chaque participant tire au hasard le nom d’une autre personne du groupe.</li>
                <li>Il devient alors le « Secret Santa » (le Père Noël secret) de cette personne.</li>
                <li>L’identité de celui qui offre le cadeau reste <strong>secrète</strong> jusqu’à la fin.</li>
            </ul>
        </li>
        <li><strong>💡 Budget fixé à l’avance</strong>
            <ul><li>Le groupe s’accorde sur un <strong>montant maximum</strong> pour que les cadeaux soient équitables.</li></ul>
        </li>
        <li><strong>🎀 Achat et échange des cadeaux</strong>
            <ul><li>Chacun achète un petit cadeau pour la personne tirée au sort.</li></ul>
        </li>
        <li><strong>🤫 Option : garder le secret ou le révéler</strong>
            <ul><li>Parfois on garde le secret, parfois on révèle à la fin.</li></ul>
        </li>
    </ol>

    <div class="note">
        👉 Le but principal est de <strong>partager un moment amusant et chaleureux</strong> sans que chacun ait à acheter pour tout le monde.
    </div>

    <div style="margin-top:20px;">
      <!-- bouton de tirage : contient l'id utilisateur connecté -->
      <button class="btn btn-success" id="drawBtn" {{ draw_button_state }} data-user-id="{{ user_id }}">Tirer au sort</button>
      <span id="drawResult" style="margin-left:12px;"></span>
    </div>

    <div {{ hidden_draw }}>
        Vous devez offrir à : {{ receiver_name }} !
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function draw() {
        const btn = document.getElementById('drawBtn');
        const userId = btn.getAttribute('data-user-id');
        if (!userId) {
            alert('ID utilisateur non disponible.');
            return;
        }
        console.log('ID utilisateur :', Number(userId));
        btn.disabled = true;
        const res = await fetch('/secret_santa/api/draw', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: Number(userId) })
        });
        if (!res.ok) {
            const text = await res.text();
            document.getElementById('drawResult').textContent = 'Erreur: ' + res.status + ' ' + text;
            return;
        }
        const json = await res.json();
        document.getElementById('drawResult').textContent = 'Vous devez offrir à : ' + json.assigned_name + ' !';
    }

    document.getElementById('drawBtn').addEventListener('click', draw);
</script>
{% endblock %}